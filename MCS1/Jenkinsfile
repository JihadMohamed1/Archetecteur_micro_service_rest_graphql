@Library('Jenkins_shared_library')
def gv

pipeline{
  agent any
  tools{
    maven 'maven'
  }
 
  stages{
    stage(" increment stage"){
      steps{
        script{
          echo ' increment app version..'
          sh'mvn -f MCS1/pom.xml build-helper:parse-version versions:set \
          -DnewVersion=\\\${parsedVersion.majorVersion}.\\\${parsedVersion.minorVersion}.\\\${parsedVersion.nextIncrementalVersion} \
          versions:commit'
          echo 'befor read'
          def matcher = readFile('MCS1/pom.xml') =~ '<version>(.+)</version>'
           echo 'after read'
          def version = matcher[0][1]
          echo 'after matcher'
          env.IMAGE_NAME="$version-$BUILD_NUMBER"
          echo 'end incre '
        }
      }
    }
        stage("init"){
      steps{

        echo 'here tigger is working hope gama '

       script{
         gv = load "MCS1/script.groovy"
       }
        echo 'here end'
        
            }
                 }
    stage("build jar"){
      steps{
        script{
       buildJar()
        }
            }
                 }
     stage("build image"){
      steps{
        script{
        buildImage "67.205.176.30:8083/java-app:${IMAGE_NAME}"
        dockerLogin()
        dockerPush "67.205.176.30:8083/java-app:${IMAGE_NAME}"
        }
            }
                 }
   
    stage("deploy"){
      steps{
        echo 'deployment'
            }
         }
    
    stage("commit version"){
      steps{
         script{
           withCredentials([usernamePassword(credentialsId:'github_cred', passwordVariable : 'PASS', usernameVariable : 'USER')]){
           sh 'git config --global user.email "jenkins@example.com" '
            sh 'git config --global user.name "jenkins"'
             
             sh 'git status'
             sh 'git branch'
             sh 'git config --list '
             
             sh "git remote set-url origin https://${USER}:${PASS}@github.com/JihadMohamed1/Archetecteur_micro_service_rest_graphql"
             sh 'git add .'
             sh 'git commit -m "c1:version bump"'
             sh 'git push origin HEAD:jenkins-job'
           }
               }
            }
         }
  }
  
}
